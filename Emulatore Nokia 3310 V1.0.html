<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nokia 3310 Emulator</title>
    <!-- Carica Tailwind CSS per lo stile base -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        
        body {
            background-color: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Roboto Mono', monospace;
            color: #ecf0f1;
        }
        
        .nokia-phone {
            width: 300px;
            height: 600px;
            background-color: #34495e;
            border-radius: 30px;
            border: 10px solid #2c3e50;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .phone-antenna {
            width: 30px;
            height: 20px;
            background-color: #2c3e50;
            border-radius: 5px 5px 0 0;
            position: absolute;
            top: 0;
        }

        .phone-speaker {
            width: 50px;
            height: 8px;
            background-color: #2c3e50;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .phone-screen {
            width: 250px;
            height: 150px;
            background-color: #8c8c8c;
            border: 3px solid #1a1a1a;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            font-size: 14px;
        }

        .screen-top {
            width: 100%;
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #4a4a4a;
        }

        .screen-content {
            flex-grow: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            color: #1a1a1a;
            white-space: pre-wrap;
            text-align: left;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .screen-content::-webkit-scrollbar { 
            display: none;
        }

        .screen-content .item {
            width: 100%;
            padding: 2px 5px;
            margin: 1px 0;
            display: flex;
            justify-content: space-between;
        }

        .screen-content .item .unread-dot {
            width: 6px;
            height: 6px;
            background-color: #000;
            border-radius: 50%;
            margin-left: 5px;
        }

        .screen-content .item.active {
            color: white;
            background-color: #1a1a1a;
        }
        
        .screen-bottom {
            width: 100%;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #1a1a1a;
        }

        /* Nuovi stili per i tasti funzione sotto lo schermo */
        .soft-key-row {
            display: flex;
            justify-content: space-between;
            width: 250px;
            margin-top: 10px;
        }

        .soft-key {
            width: 40px;
            height: 20px;
            background-color: #2c3e50;
            border: 2px solid #34495e;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.1s ease-in-out;
            user-select: none;
        }

        .soft-key:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
            width: 100%;
        }

        .key-row {
            display: contents;
        }
        
        .key {
            width: 60px;
            height: 40px;
            background-color: #2c3e50;
            color: #ecf0f1;
            border: 2px solid #34495e;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: all 0.1s ease-in-out;
            user-select: none;
        }

        .key:active {
            transform: translateY(2px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.3);
        }

        .function-key-row {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .function-key {
            width: 80px;
            height: 30px;
            background-color: #2c3e50;
            border: 2px solid #34495e;
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: all 0.1s ease-in-out;
            user-select: none;
        }
        
        .function-key:active {
            transform: translateY(2px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.3);
        }

        .green-key {
            background-color: #27ae60;
            font-size: 18px;
        }

        .red-key {
            background-color: #e74c3c;
            font-size: 18px;
        }

        .nav-key-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            gap: 10px;
        }

        .nav-key {
            width: 30px;
            height: 30px;
            background-color: #2c3e50;
            border: 2px solid #34495e;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: all 0.1s ease-in-out;
            user-select: none;
        }

        .nav-key:active {
            transform: translateY(2px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.3);
        }

        .nav-key.center {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .loading-dots:after {
            overflow: hidden;
            display: inline-block;
            vertical-align: bottom;
            -webkit-animation: ellipsis steps(4,end) 900ms infinite;      
            animation: ellipsis steps(4,end) 900ms infinite;
            content: "\2026";
            width: 0px;
        }
        
        @keyframes ellipsis {
            to {
                width: 1.25em;    
            }
        }
        
        /* Stile per la schermata di avvio */
        .startup-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #34495e;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            color: white;
            z-index: 10;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        
        .startup-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .nokia-logo {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px #2c3e50;
        }
        
        .operator-name {
            font-size: 20px;
            font-weight: bold;
            margin-top: 10px;
        }

    </style>
</head>
<body>

    <div class="nokia-phone">
        <!-- Schermata di avvio -->
        <div class="startup-screen" id="startup-screen">
            <div class="nokia-logo">NOKIA</div>
            <div class="operator-name">Omnitel</div>
            <div>Avvio in corso...</div>
        </div>

        <div class="phone-antenna"></div>
        <div class="phone-speaker"></div>
        <div class="phone-screen">
            <div class="screen-top">
                <span id="signalAndOperator">Omnitel ðŸ“¶</span>
                <span id="time"></span>
            </div>
            <div class="screen-content" id="screenContent"></div>
            <div class="screen-bottom">
                <span id="leftAction"></span>
                <span id="rightAction"></span>
            </div>
        </div>
        
        <!-- Nuovi tasti funzione sotto lo schermo -->
        <div class="soft-key-row">
            <div class="soft-key" data-key="soft-left" id="soft-left"></div>
            <div class="soft-key" data-key="soft-right" id="soft-right"></div>
        </div>

        <div class="function-key-row">
            <!-- Pulsanti di navigazione centrali -->
            <div class="nav-key" data-key="ArrowUp">â–²</div>
            <div class="nav-key center" data-key="Enter"></div>
            <div class="nav-key" data-key="ArrowDown">â–¼</div>
        </div>

        <div class="function-key-row">
            <!-- Pulsanti di chiamata e fine chiamata -->
            <div class="function-key green-key" data-key="call">ðŸ“ž</div>
            <div class="function-key red-key" data-key="hang-up">ðŸ”´</div>
        </div>

        <div class="keypad">
            <div class="key-row">
                <div class="key" data-key="1">1</div>
                <div class="key" data-key="2">2 <br> ABC</div>
                <div class="key" data-key="3">3 <br> DEF</div>
            </div>
            <div class="key-row">
                <div class="key" data-key="4">4 <br> GHI</div>
                <div class="key" data-key="5">5 <br> JKL</div>
                <div class="key" data-key="6">6 <br> MNO</div>
            </div>
            <div class="key-row">
                <div class="key" data-key="7">7 <br> PQRS</div>
                <div class="key" data-key="8">8 <br> TUV</div>
                <div class="key" data-key="9">9 <br> WXYZ</div>
            </div>
            <div class="key-row">
                <div class="key" data-key="*">*</div>
                <div class="key" data-key="0">0</div>
                <div class="key" data-key="#">#</div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const screenContent = document.getElementById('screenContent');
            const timeDisplay = document.getElementById('time');
            const signalAndOperator = document.getElementById('signalAndOperator');
            const leftAction = document.getElementById('leftAction');
            const rightAction = document.getElementById('rightAction');
            const softLeftKey = document.getElementById('soft-left');
            const softRightKey = document.getElementById('soft-right');
            const keys = document.querySelectorAll('.key, .function-key, .nav-key, .soft-key');
            const phoneScreen = document.querySelector('.phone-screen');
            const functionKeys = document.querySelectorAll('.function-key');
            const startupScreen = document.getElementById('startup-screen');

            // --- Stato dell'emulatore ---
            let currentView = 'startup'; // 'startup', 'mainMenu', 'messages', 'contacts', 'calls', 'manager', 'incomingCall', 'onCall', 'messageContent', 'contactDetails'
            let selectedIndex = 0;
            let history = []; // Per gestire il pulsante "Indietro"
            let callTimer = null;
            let incomingCallInterval = null;
            let randomMessageInterval = null;
            let isGenerating = false;
            let isInitializing = true;
            let activeCallContact = null;
            const operatorName = 'Omnitel';

            // --- Dati mockati ---
            const mainMenuItems = ['Messaggi', 'Chiamate', 'Contatti', 'Gestore', 'Impostazioni'];
            const managerItems = ['Genera Contatti âœ¨', 'Cancella Messaggi'];
            
            // Genera 40 contatti casuali
            function generateContacts() {
                const names = ['Mario Rossi', 'Giulia Bianchi', 'Luca Verdi', 'Anna Neri', 'Marco Gialli', 'Sara Marroni', 'Paolo Forti', 'Elena Rossi', 'Giovanni Sassi', 'Laura Boni'];
                const contacts = [];
                for (let i = 0; i < 40; i++) {
                    const name = names[Math.floor(Math.random() * names.length)] + ' ' + (i + 1);
                    const number = '3' + Math.floor(100000000 + Math.random() * 900000000).toString();
                    contacts.push({ name, number, details: 'Nessun dettaglio extra.' });
                }
                return contacts;
            }
            let contacts = generateContacts();

            // Dati iniziali per messaggi e chiamate
            let messages = [
                { id: 1, contact: 'Giulia', text: 'Ciao, come stai?', type: 'received', status: 'read' },
                { id: 2, contact: 'Mario', text: 'Tutto bene, grazie!', type: 'sent', status: 'read' },
                { id: 3, contact: 'Luca', text: 'Ci vediamo dopo al bar?', type: 'received', status: 'unread' }
            ];
            let callLog = [
                { id: 1, contact: 'Anna', time: '12:30', type: 'received' },
                { id: 2, contact: 'Paolo', time: '10:15', type: 'dialed' },
                { id: 3, contact: 'Mario', time: '09:00', type: 'missed' }
            ];

            // --- Funzioni di rendering ---

            // Aggiorna l'ora ogni secondo
            function updateTime() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                timeDisplay.textContent = `${hours}:${minutes}`;
            }
            setInterval(updateTime, 1000);
            updateTime();

            // Renderizza il menu principale
            function renderMainMenu() {
                let html = '';
                mainMenuItems.forEach((item, index) => {
                    const isActive = index === selectedIndex;
                    html += `<div class="item ${isActive ? 'active' : ''}"><span>${isActive ? ' > ' : '   '}${item}</span></div>`;
                });
                screenContent.innerHTML = html;
                leftAction.textContent = 'Seleziona';
                rightAction.textContent = 'Indietro';
                currentView = 'mainMenu';
            }

            // Renderizza l'elenco dei messaggi
            function renderMessages() {
                let html = '';
                messages.forEach((msg, index) => {
                    const isActive = index === selectedIndex;
                    const unreadDot = msg.status === 'unread' ? '<span class="unread-dot"></span>' : '';
                    html += `<div class="item ${isActive ? 'active' : ''}"><span>${isActive ? ' > ' : '   '}${msg.contact}</span>${unreadDot}</div>`;
                });
                screenContent.innerHTML = html;
                leftAction.textContent = 'Apri';
                rightAction.textContent = 'Indietro';
                currentView = 'messages';
            }

            // Renderizza il contenuto di un singolo messaggio
            function renderMessageContent(message) {
                history.push({ view: 'messages', selectedIndex: selectedIndex, leftAction: leftAction.textContent, rightAction: rightAction.textContent });
                screenContent.innerHTML = `
                    <div style="text-align: left; padding: 5px; width: 100%;">
                        <div style="font-weight: bold;">Da: ${message.contact}</div>
                        <div style="margin-top: 10px; font-size: 12px; white-space: pre-wrap;">${message.text}</div>
                    </div>
                `;
                leftAction.textContent = 'Rispondi âœ¨';
                rightAction.textContent = 'Indietro';
                currentView = 'messageContent';
            }

            // Renderizza l'elenco dei contatti
            function renderContacts() {
                let html = '';
                contacts.forEach((contact, index) => {
                    const isActive = index === selectedIndex;
                    html += `<div class="item ${isActive ? 'active' : ''}"><span>${isActive ? ' > ' : '   '}${contact.name}</span></div>`;
                });
                screenContent.innerHTML = html;
                leftAction.textContent = 'Dettagli';
                rightAction.textContent = 'Indietro';
                currentView = 'contacts';
            }

            // Renderizza i dettagli di un contatto
            function renderContactDetails(contact) {
                history.push({ view: 'contacts', selectedIndex: selectedIndex, leftAction: leftAction.textContent, rightAction: rightAction.textContent });
                screenContent.innerHTML = `
                    <div style="text-align: left; padding: 5px; width: 100%;">
                        <div style="font-weight: bold;">Nome: ${contact.name}</div>
                        <div style="font-weight: bold;">Numero: ${contact.number}</div>
                        <div style="margin-top: 10px; font-size: 12px; white-space: pre-wrap;">Dettagli: ${contact.details}</div>
                    </div>
                `;
                leftAction.textContent = 'Genera Dettagli âœ¨';
                rightAction.textContent = 'Indietro';
                currentView = 'contactDetails';
            }
            
            // Renderizza il menu del gestore
            function renderManager() {
                let html = '';
                managerItems.forEach((item, index) => {
                    const isActive = index === selectedIndex;
                    html += `<div class="item ${isActive ? 'active' : ''}"><span>${isActive ? ' > ' : '   '}${item}</span></div>`;
                });
                screenContent.innerHTML = html;
                leftAction.textContent = 'Esegui';
                rightAction.textContent = 'Indietro';
                currentView = 'manager';
            }

            // Renderizza il registro delle chiamate
            function renderCalls() {
                let html = '';
                callLog.forEach((call, index) => {
                    const isActive = index === selectedIndex;
                    html += `<div class="item ${isActive ? 'active' : ''}"><span>${isActive ? ' > ' : '   '}${call.contact} (${call.time})</span></div>`;
                });
                screenContent.innerHTML = html;
                leftAction.textContent = 'Chiama';
                rightAction.textContent = 'Indietro';
                currentView = 'calls';
            }

            // Renderizza una chiamata in arrivo
            function renderIncomingCall(callerName, callerNumber = null) {
                activeCallContact = { name: callerName, number: callerNumber };

                let contentHtml = `<div style="text-align: center; margin-top: 20px;">
                    <div style="font-size: 16px; font-weight: bold;">Chiamata in arrivo</div>
                    <div style="font-size: 20px; font-weight: bold; margin-top: 10px;">${callerName}</div>`;
                if (callerNumber) {
                    contentHtml += `<div style="font-size: 14px; margin-top: 5px;">${callerNumber}</div>`;
                }
                contentHtml += `</div>`;
                screenContent.innerHTML = contentHtml;
                
                leftAction.textContent = 'Rispondi';
                rightAction.textContent = 'Rifiuta';
                currentView = 'incomingCall';
            }

            // Renderizza lo stato di una chiamata in corso
            function renderOnCall(callee) {
                screenContent.innerHTML = `
                    <div style="text-align: center; margin-top: 20px;">
                        <div style="font-size: 16px;">Chiamata in corso con:</div>
                        <div style="font-size: 20px; font-weight: bold; margin-top: 10px;">${callee}</div>
                    </div>
                `;
                leftAction.textContent = '';
                rightAction.textContent = 'Termina';
                currentView = 'onCall';
            }

            // Mostra un messaggio di default
            function showMessage(message, leftBtn = '', rightBtn = 'Indietro') {
                history.push({ view: currentView, selectedIndex: selectedIndex, leftAction: leftAction.textContent, rightAction: rightAction.textContent });
                screenContent.innerHTML = `<pre style="text-align: center; padding-top: 20px;">${message}</pre>`;
                leftAction.textContent = leftBtn;
                rightAction.textContent = rightBtn;
                currentView = 'message';
            }

            // --- Funzione per la vibrazione ---
            function vibratePhone(pattern) {
                if ("vibrate" in navigator) {
                    navigator.vibrate(pattern);
                }
            }

            // --- Funzioni Gemini API ---
            async function generateText(prompt) {
                isGenerating = true;
                screenContent.innerHTML = `<div style="text-align: center; padding-top: 20px;">Generazione in corso<span class="loading-dots"></span></div>`;

                let text = "";
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                let response;
                let result;
                let retries = 0;
                const maxRetries = 5;
                const baseDelay = 1000;

                while (retries < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) {
                            result = await response.json();
                            break;
                        }
                    } catch (e) {
                        // Ignora l'errore e riprova con un ritardo maggiore
                    }
                    retries++;
                    await new Promise(resolve => setTimeout(resolve, baseDelay * Math.pow(2, retries)));
                }

                if (result && result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    text = result.candidates[0].content.parts[0].text;
                } else {
                    text = "Impossibile generare il contenuto. Riprova piÃ¹ tardi.";
                }
                
                isGenerating = false;
                return text;
            }

            // Funzione per generare una risposta a un messaggio
            async function generateMessageReply(messageText) {
                const prompt = `Devi rispondere a questo messaggio in modo breve (massimo 10 parole), amichevole e colloquiale, come se fossi un amico che risponde su un vecchio telefono. Il messaggio Ã¨: "${messageText}". Rispondi solo con il testo del messaggio di risposta, senza frasi introduttive come 'Risposta: ' o saluti.`;
                const replyText = await generateText(prompt);
                
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                
                const newMessage = {
                    id: Date.now(),
                    contact: messages[selectedIndex].contact,
                    text: replyText,
                    type: 'sent',
                    status: 'read'
                };
                
                messages.push(newMessage);
                
                // Aggiorna la schermata dei messaggi per mostrare la nuova risposta
                goBack();
                renderMessages();
            }

            async function generateRandomMessage() {
                const prompt = "Genera un messaggio di testo casuale, breve e amichevole, come se fosse inviato da un amico. Usa un tono colloquiale e informale. Evita di usare saluti formali come 'Ciao' o 'Buona giornata'. Rispondi solo con il testo del messaggio, senza frasi introduttive.";
                const messageText = await generateText(prompt);
                
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                
                const isSpam = Math.random() < 0.1; // Ridotta probabilitÃ  di spam
                let sender;

                if (isSpam) {
                    sender = 'SPAM';
                } else {
                    sender = contacts[Math.floor(Math.random() * contacts.length)].name;
                }

                const newMessage = {
                    id: Date.now(),
                    contact: sender,
                    text: messageText,
                    type: 'received',
                    status: 'unread'
                };

                messages.unshift(newMessage);
                
                // Fa vibrare il telefono per un messaggio in arrivo
                vibratePhone([200, 100, 200]);
                
                // Se siamo giÃ  nella schermata dei messaggi, la aggiorniamo
                if (currentView === 'messages') {
                    renderMessages();
                }
            }
            
            async function generateContactDetails(contactName) {
                const prompt = `Genera un breve dettaglio fittizio (non piÃ¹ di 30 parole) per un contatto di nome ${contactName}. PuÃ² essere un'osservazione divertente, un hobby, un fatto curioso o un promemoria. Rispondi solo con il testo del dettaglio, senza frasi introduttive come 'Dettaglio: ' o 'CuriositÃ : '.`;
                const details = await generateText(prompt);
                
                const contact = contacts.find(c => c.name === contactName);
                if (contact) {
                    contact.details = details;
                }
                
                renderContactDetails(contact);
            }

            // --- Logica delle chiamate ---
            function startIncomingCallTimer() {
                // Simula una chiamata in arrivo ogni 15-30 secondi
                const randomTime = Math.floor(Math.random() * (30000 - 15000 + 1)) + 15000;
                incomingCallInterval = setTimeout(() => {
                    simulateIncomingCall();
                }, randomTime);
            }

            function simulateIncomingCall() {
                if (currentView === 'incomingCall' || currentView === 'onCall') {
                    startIncomingCallTimer();
                    return;
                }
                const isSpam = Math.random() < 0.2; // 20% di possibilitÃ  di spam
                
                let caller;
                if (isSpam) {
                    caller = { name: 'Numero Sconosciuto', number: '' };
                } else {
                    caller = contacts[Math.floor(Math.random() * contacts.length)];
                }
                
                // Fa vibrare il telefono per una chiamata in arrivo
                vibratePhone([500, 300, 500, 300, 500]);

                renderIncomingCall(caller.name, caller.number);
            }

            function handleCallAction(action) {
                if (currentView !== 'incomingCall') return;
                clearTimeout(incomingCallInterval);
                // Ferma la vibrazione quando si risponde o si rifiuta
                vibratePhone(0);
                
                const callerName = activeCallContact.name;
                const callerNumber = activeCallContact.number;

                if (action === 'answer') {
                    renderOnCall(callerName);
                    callLog.unshift({ id: Date.now(), contact: callerName, number: callerNumber, time: timeDisplay.textContent, type: 'received' });
                    // Simula la fine della chiamata dopo 5 secondi
                    callTimer = setTimeout(() => {
                        goBack();
                        startIncomingCallTimer();
                    }, 5000);
                } else if (action === 'hang-up') {
                    callLog.unshift({ id: Date.now(), contact: callerName, number: callerNumber, time: timeDisplay.textContent, type: 'missed' });
                    goBack();
                    startIncomingCallTimer();
                }
            }

            // --- Gestione della navigazione ---

            function goBack() {
                if (isInitializing) return;

                if (currentView === 'messageContent' || currentView === 'message') {
                    const lastState = history.pop();
                    selectedIndex = lastState.selectedIndex;
                    currentView = lastState.view;
                    leftAction.textContent = lastState.leftAction;
                    rightAction.textContent = lastState.rightAction;
                    renderMessages();
                    return;
                }

                if (currentView === 'contactDetails') {
                    const lastState = history.pop();
                    selectedIndex = lastState.selectedIndex;
                    currentView = lastState.view;
                    leftAction.textContent = lastState.leftAction;
                    rightAction.textContent = lastState.rightAction;
                    renderContacts();
                    return;
                }
                
                if (history.length > 0) {
                    const lastState = history.pop();
                    selectedIndex = lastState.selectedIndex;
                    currentView = lastState.view;
                    leftAction.textContent = lastState.leftAction;
                    rightAction.textContent = lastState.rightAction;
                    
                    // Renderizza la view precedente
                    switch(currentView) {
                        case 'mainMenu':
                            renderMainMenu();
                            break;
                        case 'messages':
                            renderMessages();
                            break;
                        case 'contacts':
                            renderContacts();
                            break;
                        case 'calls':
                            renderCalls();
                            break;
                        case 'manager':
                            renderManager();
                            break;
                        default:
                            renderMainMenu();
                            break;
                    }
                } else {
                    renderMainMenu();
                }
            }

            // --- Gestione dei tasti ---
            function handleKeyPress(key) {
                if (isGenerating || isInitializing) return;

                if (currentView === 'incomingCall') {
                    if (key === 'call' || key === 'soft-left') {
                        handleCallAction('answer');
                    } else if (key === 'hang-up' || key === 'soft-right') {
                        handleCallAction('hang-up');
                    }
                    return;
                }
                
                if (currentView === 'onCall') {
                    if (key === 'hang-up' || key === 'soft-right') {
                        clearTimeout(callTimer);
                        goBack();
                        startIncomingCallTimer();
                    }
                    return;
                }

                switch (key) {
                    case 'ArrowUp':
                        if (currentView === 'mainMenu') {
                            selectedIndex = (selectedIndex - 1 + mainMenuItems.length) % mainMenuItems.length;
                            renderMainMenu();
                        } else if (currentView === 'messages') {
                            selectedIndex = (selectedIndex - 1 + messages.length) % messages.length;
                            renderMessages();
                        } else if (currentView === 'contacts') {
                            selectedIndex = (selectedIndex - 1 + contacts.length) % contacts.length;
                            renderContacts();
                        } else if (currentView === 'calls') {
                            selectedIndex = (selectedIndex - 1 + callLog.length) % callLog.length;
                            renderCalls();
                        } else if (currentView === 'manager') {
                            selectedIndex = (selectedIndex - 1 + managerItems.length) % managerItems.length;
                            renderManager();
                        } else if (currentView === 'messageContent' || currentView === 'contactDetails') {
                            // Scroll up
                        }
                        break;
                    case 'ArrowDown':
                        if (currentView === 'mainMenu') {
                            selectedIndex = (selectedIndex + 1) % mainMenuItems.length;
                            renderMainMenu();
                        } else if (currentView === 'messages') {
                            selectedIndex = (selectedIndex + 1) % messages.length;
                            renderMessages();
                        } else if (currentView === 'contacts') {
                            selectedIndex = (selectedIndex + 1) % contacts.length;
                            renderContacts();
                        } else if (currentView === 'calls') {
                            selectedIndex = (selectedIndex + 1) % callLog.length;
                            renderCalls();
                        } else if (currentView === 'manager') {
                            selectedIndex = (selectedIndex + 1) % managerItems.length;
                            renderManager();
                        } else if (currentView === 'messageContent' || currentView === 'contactDetails') {
                            // Scroll down
                        }
                        break;
                    case 'Enter':
                    case 'soft-left': // Usiamo il pulsante soft-left come 'Seleziona'
                        if (currentView === 'mainMenu') {
                            history.push({ view: currentView, selectedIndex: selectedIndex, leftAction: leftAction.textContent, rightAction: rightAction.textContent });
                            const selectedItem = mainMenuItems[selectedIndex];
                            selectedIndex = 0;
                            if (selectedItem === 'Messaggi') {
                                renderMessages();
                            } else if (selectedItem === 'Chiamate') {
                                renderCalls();
                            } else if (selectedItem === 'Contatti') {
                                renderContacts();
                            } else if (selectedItem === 'Gestore') {
                                renderManager();
                            } else {
                                showMessage(`\nEsegui:\n  ${selectedItem}`);
                            }
                        } else if (currentView === 'messages') {
                            const selectedMessage = messages[selectedIndex];
                            selectedMessage.status = 'read';
                            renderMessageContent(selectedMessage);
                        } else if (currentView === 'contacts') {
                            const selectedContact = contacts[selectedIndex];
                            renderContactDetails(selectedContact);
                        } else if (currentView === 'calls') {
                            const call = callLog[selectedIndex];
                            showMessage(`\nChiami:\n  ${call.contact}`);
                        } else if (currentView === 'contactDetails') {
                            const selectedContact = contacts[selectedIndex];
                            if (leftAction.textContent.includes('Genera Dettagli âœ¨')) {
                                generateContactDetails(selectedContact.name);
                            }
                        } else if (currentView === 'messageContent') {
                             const selectedMessage = messages[selectedIndex];
                             if (leftAction.textContent.includes('Rispondi âœ¨')) {
                                 generateMessageReply(selectedMessage.text);
                             }
                        } else if (currentView === 'manager') {
                            const selectedManagerAction = managerItems[selectedIndex];
                            if (selectedManagerAction === 'Genera Contatti âœ¨') {
                                contacts = generateContacts();
                                showMessage(`\nGenerati 40 nuovi contatti.`);
                            } else if (selectedManagerAction === 'Cancella Messaggi') {
                                messages = [];
                                showMessage(`\nCancellati tutti i messaggi.`);
                            }
                        }
                        break;
                    case 'soft-right': // Pulsante "Indietro"
                        if (currentView === 'messageContent' || currentView === 'contactDetails' || currentView === 'message') {
                            goBack();
                        } else if (currentView !== 'mainMenu') {
                            history.push({ view: currentView, selectedIndex: selectedIndex, leftAction: leftAction.textContent, rightAction: rightAction.textContent });
                            selectedIndex = 0;
                            renderMainMenu();
                        }
                        break;
                    case 'call': // Pulsante Chiamata Verde
                        if (currentView === 'contacts' && contacts.length > 0) {
                            const contactToCall = contacts[selectedIndex];
                            showMessage(`\nChiami:\n  ${contactToCall.name}\n  ${contactToCall.number}`);
                        } else {
                            showMessage('\nFunzione di chiamata non implementata.');
                        }
                        break;
                    case 'hang-up': // Pulsante Fine Chiamata Rosso
                        if (currentView === 'message' || currentView === 'contactDetails') {
                            goBack();
                        } else {
                            showMessage('\nPremi un tasto per tornare al menu.');
                        }
                        break;
                    default:
                        // Gestisce i tasti numerici e i simboli
                        const numberKey = Array.from(keys).find(k => k.dataset.key === key);
                        if (numberKey && currentView !== 'message' && currentView !== 'messageContent') {
                            const numberText = numberKey.textContent.trim().split(' ')[0];
                            showMessage(`Hai premuto il tasto:\n  ${numberText}`);
                        }
                        break;
                }
            }

            // Ascolta i click sui tasti del telefono
            keys.forEach(key => {
                key.addEventListener('click', () => {
                    handleKeyPress(key.dataset.key);
                });
            });

            // Ascolta gli eventi della tastiera del computer
            document.addEventListener('keydown', (e) => {
                const keyMapping = {
                    '1': '1', '2': '2', '3': '3',
                    '4': '4', '5': '5', '6': '6',
                    '7': '7', '8': '8', '9': '9',
                    '*': '*', '0': '0', '#': '#',
                    'Enter': 'Enter',
                    'ArrowUp': 'ArrowUp',
                    'ArrowDown': 'ArrowDown'
                };
                const mappedKey = keyMapping[e.key];
                if (mappedKey) {
                    handleKeyPress(mappedKey);
                }
                
                // Mappa i pulsanti soft keys e i tasti di chiamata
                if (e.key === 'q' || e.key === 'Q') {
                    handleKeyPress('soft-left');
                } else if (e.key === 'e' || e.key === 'E') {
                    handleKeyPress('soft-right');
                } else if (e.key === 'a' || e.key === 'A') {
                    handleKeyPress('call');
                } else if (e.key === 'd' || e.key === 'D') {
                    handleKeyPress('hang-up');
                }
            });

            // Avvia l'emulatore con una schermata di avvio
            setTimeout(() => {
                startupScreen.classList.add('hidden');
                isInitializing = false;
                renderMainMenu();
                startIncomingCallTimer();
                randomMessageInterval = setInterval(generateRandomMessage, 30000); // Messaggi casuali ogni 30 secondi
            }, 3000); // 3 secondi di avvio
        });
    </script>
</body>
</html>
